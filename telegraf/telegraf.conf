[agent]
  interval = "10s"
  flush_interval = "10s"
  omit_hostname = true

[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  topics  = ["acrss/states/+/+"]

  client_id = "telegraf-states"

  username = "${MQTT_USER}"
  password = "${MQTT_PASSWORD}"

  data_format = "json"
  json_time_key = "ts"
  json_time_format = "unix_ms"

  name_override = "vitals_state"

  topic_tag = "topic"


[[processors.regex]]
  namepass = ["vitals_state"]

  # patient_id
  [[processors.regex.tags]]
    key = "topic"
    pattern = "acrss/states/([^/]+)/([^/]+)"
    replacement = "${1}"
    result_key = "patient_id"

  # sensor
  [[processors.regex.tags]]
    key = "topic"
    pattern = "acrss/states/([^/]+)/([^/]+)"
    replacement = "${2}"
    result_key = "sensor"


[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  topics  = ["acrss/symptoms/+"]

  client_id = "telegraf-symptoms"
  qos = 1

  username = "${MQTT_USER}"
  password = "${MQTT_PASSWORD}"

  name_override = "symptoms"

  topic_tag = "topic"
  data_format = "json_v2"

  [[inputs.mqtt_consumer.json_v2]]
    timestamp_path = "timestamp"
    timestamp_format = "unix_ms"

    [[inputs.mqtt_consumer.json_v2.field]]
      path = "status.oxigenation"
      rename = "status_oxigenation"
      type = "string"

    [[inputs.mqtt_consumer.json_v2.field]]
      path = "status.respiration"
      rename = "status_respiration"
      type = "string"

    [[inputs.mqtt_consumer.json_v2.field]]
      path = "status.heart_rate"
      rename = "status_heart_rate"
      type = "string"

    [[inputs.mqtt_consumer.json_v2.field]]
      path = "status.blood_pressure"
      rename = "status_blood_pressure"
      type = "string"

    [[inputs.mqtt_consumer.json_v2.field]]
      path = "trend.hr"
      rename = "trend_hr"
      type = "string"

    [[inputs.mqtt_consumer.json_v2.field]]
      path = "trend.rr"
      rename = "trend_rr"
      type = "string"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "trend.spo2"
      rename = "trend_spo2"
      type = "string"

    [[inputs.mqtt_consumer.json_v2.field]]
      path = "trend.sbp"
      rename = "trend_sbp"
      type = "string"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "trend.dbp"
      rename = "trend_dbp"
      type = "string"

    [[inputs.mqtt_consumer.json_v2.field]]
      path = "trend.map"
      rename = "trend_map"
      type = "string"

    [[inputs.mqtt_consumer.json_v2.field]]
      path = "intensity.hr"
      rename = "intensity_hr"
      type = "string"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "intensity.rr"
      rename = "intensity_rr"
      type = "string"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "intensity.spo2"
      rename = "intensity_spo2"
      type = "string"

    [[inputs.mqtt_consumer.json_v2.field]]
      path = "intensity.sbp"
      rename = "intensity_sbp"
      type = "string"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "intensity.dbp"
      rename = "intensity_dbp"
      type = "string"
    
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "intensity.map"
      rename = "intensity_map"
      type = "string"

[[processors.regex]]
  namepass = ["symptoms"]

  [[processors.regex.tags]]
    key = "topic"
    pattern = "acrss/symptoms/([^/]+)"
    replacement = "${1}"
    result_key = "patient_id"

[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  topics  = ["acrss/therapies/+"]

  client_id = "telegraf-therapies"
  qos = 1

  username = "${MQTT_USER}"
  password = "${MQTT_PASSWORD}"

  name_override = "therapies"

  topic_tag = "topic"
  data_format = "json_v2"

  [[inputs.mqtt_consumer.json_v2]]
    timestamp_path = "timestamp"
    timestamp_format = "2006-01-02T15:04:05.999999"

    # === OXYGEN THERAPY (INT) ===
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "ox_therapy"
      type = "int"

    # === FLUIDS (STRING or null) ===
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "fluids"
      type = "string"
      optional = true

    # === BETA BLOCKER DOSE (FLOAT) ===
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "carvedilolo_beta_blocking"
      type = "float"

    # === ALERT ARRAY (saved as string) ===
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "alert"
      type = "string"

      


[[processors.regex]]
  namepass = ["therapies"]

  [[processors.regex.tags]]
    key = "topic"
    pattern = "acrss/therapies/([^/]+)"
    replacement = "${1}"
    result_key = "patient_id"

[[processors.starlark]]
  namepass = ["therapies"]
  source = '''
def apply(metric):

    fluids = metric.fields.get("fluids")

    if fluids == None or fluids == "":
        metric.fields["has_fluids"] = 0
    else:
        metric.fields["has_fluids"] = 1

    return metric
'''


[[outputs.influxdb_v2]]
  urls = ["${INFLUX_URL}"]
  token = "${INFLUX_TOKEN}"
  organization = "${INFLUX_ORG}"
  bucket = "${INFLUX_BUCKET}"

   # Formatting
  tagexclude = ["topic"]
